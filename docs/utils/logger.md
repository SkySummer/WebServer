# 🧾 Logger 模块

`Logger` 模块是 HTTP 服务器的日志记录核心，负责统一管理日志输出、文件存储及分级过滤，支持按日期轮换日志文件，并提供线程安全的日志写入机制，确保运行状态可追溯、可监控。

## ✨ 模块职责

- **分级日志记录**：支持 `DEBUG`/`INFO`/`WARNING`/`ERROR` 四级日志，按配置过滤低优先级日志。
- **文件与时间管理**：按日期生成日志文件（如 `log_2025-01-01.log`），自动切换新文件避免单文件过大。
- **客户端上下文记录**：关联客户端地址与文件描述符（fd），增强日志可读性与调试能力。
- **线程安全写入**：通过互斥锁保证多线程环境下的日志操作原子性，避免数据竞争。

## 📌 核心特性

- **动态文件轮换**：每日生成新日志文件，旧文件保留历史记录。
- **结构化日志格式**：标准化日志条目格式（时间戳、级别、客户端信息、消息）。
- **灵活输出控制**：支持配置最低日志级别（如仅记录 `INFO` 及以上），减少冗余输出。
- **异常防护机制**：文件操作异常时输出到标准错误流（`stderr`），避免进程崩溃。

## 📁 成员组成

| 类型/名称 | 描述 |
| ---- | ---- |
| `std::ofstream file_` | 当前日志文件输出流，用于写入日志内容。 |
| `std::string filename_` | 当前日志文件名（基于日期生成，如 `log_2023-10-01.log`）。 |
| `std::mutex mutex_` | 互斥锁，保护文件操作和日志写入的线程安全。 |
| `LogLevel min_level_` | 最低日志级别，低于此级别的日志将被忽略。 |

## ⚙️ 方法概览

| 方法名称 | 功能描述 |
| ---- | ---- |
| `log` | 记录普通日志或带客户端上下文的日志（含地址和 fd）。 |
| `logDivider` | 写入分隔符（如 `========== Server start ==========`），用于划分日志段落。 |
| `generateLogFilename` | 根据当前日期生成日志文件名（格式：`log_YYYY-MM-DD.log`）。 |
| `rotateIfNeeded` | 检查日期变化，自动切换到新日志文件。 |
| `currentTime` | 获取当前时间戳（格式：`YYYY-MM-DD HH:MM:SS`）。 |
| `logLevelToString` | 将日志级别枚举值转换为字符串（如 `LogLevel::INFO` -> `"INFO"`）。 |

## 🔄 工作流程

1. **初始化阶段**
   - 构造时根据当前日期生成日志文件，打开并准备写入。
   - 设置最低日志级别 `min_level_`，过滤低优先级日志。
2. **日志写入阶段**
   - 调用 `log` 方法时，检查日志级别是否满足最低要求。
   - 执行日期轮换检查（`rotateIfNeeded`），切换新文件（若日期变更）。
   - 加锁后按格式写入日志内容，附加时间戳、级别、客户端信息（如有）。
   - 强制刷新输出流（`flush`），确保日志实时落盘。
3. **文件轮换阶段**
   - 每次写入日志前调用 `generateLogFilename` 生成当日文件名。
   - 若文件名与当前 `filename_` 不一致，关闭旧文件并创建新文件。
4. **异常处理阶段**
   - 文件打开失败时抛出异常，错误信息输出到 `stderr`。
   - 日志写入过程中捕获异常，避免中断主流程。

## 🔑 关键设计

- **日期轮换策略**：基于日期而非文件大小轮换，简化历史日志管理。
- **双重日志防护**：互斥锁（`mutex_`）保障并发安全，`flush` 操作确保数据持久化。
- **客户端上下文整合**：通过 `Address` 类关联客户端 IP、端口和 fd，增强调试能力。
- **低开销过滤机制**：在日志提交阶段直接跳过低级别日志，减少无效 I/O 操作。

## 📂 日志格式

```plaintext
[YYYY-MM-DD HH:MM:SS] [INFO] ========== message ==========
[YYYY-MM-DD HH:MM:SS] [WARNING] message
[YYYY-MM-DD HH:MM:SS] [ERROR] [Client IP:Port] [fd: x] message
```
