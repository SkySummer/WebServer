# 📦 StaticFile 模块

`StaticFile` 模块是 HTTP 服务器的静态文件服务核心，负责高效处理静态资源请求（如 HTML、CSS、JS 文件），支持缓存优化、目录列表生成及路径安全验证，确保快速响应客户端请求。

## ✨ 模块职责

- **静态文件托管**：从指定根目录（如 `./static`）提供文件服务，支持自动重定向目录请求。
- **缓存管理**：缓存已访问文件的响应内容，通过文件修改时间验证缓存有效性。
- **目录列表生成**：当请求路径为目录时，生成 HTML 格式的友好文件列表。
- **路径安全验证**：防止路径遍历攻击，确保请求路径在根目录范围内。
- **动态资源加载**：按需读取文件内容，构建 HTTP 响应并更新缓存。

## 📌 核心特性

- **智能缓存机制**：缓存文件内容和最后修改时间，减少重复磁盘 I/O 开销。
- **自动目录处理**：检测目录请求，补充斜杠重定向或生成可视化文件列表。
- **MIME 类型支持**：根据文件扩展名自动设置 `Content-Type`，兼容常见文件类型。
- **路径安全防护**：通过规范化路径检查，防止越权访问根目录外的文件。
- **高效资源释放**：缓存条目在文件被删除或修改时自动失效，避免内存泄漏。

## 📁 成员组成

| 类型/名称 | 描述 |
| ---- | ---- |
| `std::filesystem::path root_` | 静态文件根目录的绝对路径，用于定位请求资源。 |
| `mutable std::unordered_map<path, CacheEntry> cache_` | 缓存表，存储文件路径与缓存条目（响应内容及最后修改时间）。 |
| `mutable std::mutex cache_mutex_` | 保证缓存操作的线程安全，防止并发读写冲突。 |
| `Logger* logger_` | 日志记录器，用于输出调试信息、错误日志及操作状态。 |

## ⚙️ 方法概览

| 方法名称 | 功能描述 |
| ---- | ---- |
| `serve` | 处理静态资源请求，返回 HTTP 响应（文件内容、目录列表或错误页）。 |
| `generateDirectoryListing` | 生成目录的 HTML 列表页面，包含文件名称、大小和修改时间。 |
| `isPathSafe` | 验证请求路径是否在根目录范围内，防止路径遍历攻击。 |
| `getFilePath` | 将 URL 路径转换为本地文件系统路径，处理根目录拼接。 |
| `readFromCache` | 从缓存中读取文件响应，检查文件是否存在及缓存是否过期。 |
| `updateCache` | 将新读取的文件内容及元数据写入缓存，供后续请求复用。 |
| `formatSize` | 将文件大小转换为易读格式（如 KB、MB）。 |
| `formatTime` | 将文件修改时间格式化为标准时间字符串（如 `2025-01-01 14:30`）。 |

## 🔄 工作流程

1. **请求解析**：解码 URL 路径，拼接根目录生成完整文件路径。
2. **安全检查**：验证路径合法性，拦截越权访问（返回 403）。
3. **目录处理**：若路径为目录，补充斜杠重定向或生成文件列表页面。
4. **缓存查询**：检查缓存中是否存在有效响应，命中则直接返回。
5. **文件读取**：未命中缓存时读取文件内容，构建 HTTP 响应并更新缓存。
6. **异常处理**：文件不存在时返回 404 错误，记录日志并清理无效缓存条目。
