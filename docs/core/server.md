# 🚀 Server 模块

`Server` 模块是 HTTP 服务器的核心实现，负责处理网络连接、请求分发、多线程任务调度以及客户端通信管理。它基于 epoll 事件驱动模型实现高性能 I/O 复用，支持静态文件服务和动态 POST 请求处理。

## ✨ 模块职责

- **网络通信管理**：监听指定端口，处理客户端连接与断开，实现非阻塞 I/O 操作。
- **请求分发与处理**：解析 HTTP 请求方法（GET/POST），分发到线程池异步处理，生成并返回响应。
- **资源管理**：维护客户端连接状态，清理无效连接，确保资源高效回收。
- **日志与错误处理**：记录运行状态、客户端活动和异常事件，支持调试与监控。

## 📌 核心特性

- **高性能事件驱动**：基于 `epoll` 实现高并发事件监听，支持边缘触发（ET）模式，减少系统调用开销。
- **多线程任务调度**：通过线程池（`ThreadPool`）异步处理客户端请求，提升吞吐量。
- **静态文件服务**：通过 `StaticFile` 类快速响应 GET 请求，支持静态资源（如 HTML/CSS/JS）托管。
- **表单数据处理**：解析 POST 请求体，提取键值对表单数据，返回结构化结果。
- **优雅连接管理**：支持 `SO_LINGER` 选项控制连接关闭行为，避免 `TIME_WAIT` 状态堆积。

## 📁 成员组成

| 类型/名称 | 描述 |
| ---- | ---- |
| `int listen_fd_` | 监听 socket 的文件描述符，绑定指定端口并接受连接。 |
| `int epoll_fd_` | epoll 实例的文件描述符，用于监控所有 socket 事件。 |
| `int event_fd_` | 用于唤醒 `epoll_wait` 的事件文件描述符，触发关闭列表处理。 |
| `const bool linger_` | 标记是否启用 `SO_LINGER` 选项，控制连接关闭行为。 |
| `ThreadPool thread_pool_` | 线程池实例，负责异步处理客户端请求。 |
| `StaticFile static_file_` | 静态文件处理器，从指定目录（如 `./static`）提供文件服务。 |
| `std::unordered_map<int, Address> clients_` | 客户端连接缓存，记录当前活跃连接的地址信息。 |
| `std::unordered_set<int> close_list_` | 待关闭连接的客户端文件描述符集合，通过原子操作保证线程安全。 |

## ⚙️ 方法概览

| 方法名称 | 功能描述 |
| ---- | ---- |
| `setupSocket()` | 创建并配置监听 socket，绑定端口，设置为非阻塞模式。 |
| `setupEpoll()` | 初始化 epoll 实例，注册监听 socket 和唤醒 eventfd。 |
| `handleNewConnection()` | 接受新客户端连接，将其加入 epoll 监控，并记录客户端信息。 |
| `handleClientData` | 读取客户端数据，解析 HTTP 请求，生成响应并标记连接关闭。 |
| `requestCloseClient` | 将客户端标记为待关闭，通过 eventfd 触发异步清理流程。 |
| `dispatchClient` | 将客户端任务提交到线程池，捕获并处理任务提交异常。 |
| `handlePOST` | 解析 POST 请求的表单数据，返回格式化结果。 |
| `setNonBlocking` | 设置文件描述符为非阻塞模式，避免 I/O 操作阻塞线程。 |
| `processCloseList` | 清理待关闭客户端连接，释放资源并更新状态。 |
| `disconnectClient` | 从 epoll 移除客户端文件描述符，关闭连接并清理客户端缓存。 |

## 🔄 工作流程

1. **初始化**：创建监听 socket 和 epoll 实例，注册事件监听。
2. **事件循环**：通过 `epoll_wait` 等待事件触发，区分新连接、关闭通知或客户端数据。
3. **连接管理**：新连接加入 epoll 监控；关闭请求通过 eventfd 触发异步清理。
4. **任务处理**：客户端数据由线程池异步处理，生成响应后标记连接关闭。
5. **资源回收**：定期清理关闭列表中的客户端连接，释放文件描述符和内存资源。
